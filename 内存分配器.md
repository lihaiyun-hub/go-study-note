# Go 语言内存分配器

## 概览

- 程序内存分为栈与堆：栈由编译器管理，堆由分配器分配、GC 回收。
- 内存管理由三部分协作：`Mutator`（用户程序）、`Allocator`（分配器）、`Collector`（垃圾收集器）。
- Go 借鉴 TCMalloc，采用“分级 + 隔离适应”的策略，通过线程缓存降低锁争用、通过尺寸分类控制碎片。

## 分配方法

- 线性分配器（Bump Allocator）：仅维护一个指针，分配时前移指针，速度快实现简单；无法重用回收空洞，需要与复制/压缩类 GC（如 Copying、Mark-Compact、Generational）配合。
- 空闲链表分配器（Free-List）：维护空闲块链表，分配时在链表中选择合适块，时间复杂度为 O(n)。常见策略：
  - First-Fit：从头遍历选第一个合适块。
  - Next-Fit：从上次位置继续遍历。
  - Best-Fit：遍历全链表选最优块。
  - Segregated-Fit：按大小分多个链表，先定位链表再取块。Go 的分配器与此思路相近。

## 分级分配与结构

- 整体层级：每个 P 的线程缓存 `mcache` → 尺寸中央链表 `mcentral` → 全局堆 `mheap`。
- `mcache`：按“尺寸类别（size class）”维护多条自由链表，绝大多数小对象在此快速分配，无需全局锁。
- `mcentral`：每个尺寸维护一个中央自由链表，按批把 `span` 发放给 `mcache`，降低锁频率。
- `mheap`：管理更大的 `span`（由若干页组成），必要时向操作系统申请或释放虚拟内存。
- `mspan`：连续的页区间，会被切割成固定大小的对象槽位，供相应 size class 使用。
- `arena`：预留的大型虚拟地址区间，用于用户对象分配；配套页到 `span` 的索引表 `spans` 与 GC 标记位图 `bitmap`。
- 页与尺寸：以“页”为单位管理 `span`，定义有限数量的尺寸类别（约 67 类），在速度与内存浪费之间折中。

## 对象分配路径（简化）

- 入口：`mallocgc(size, typ, needzero)`。
- 零大小对象：返回共享零地址（`zerobase`），对象合法但不可读写。
- 小对象（≤ 32KB）：
  - `tiny` 路径（无指针且 < 16B）：在 `mcache` 的一个小块中顺序打包，几乎无碎片与锁开销。
  - 其他小对象：按 size class 从 `mcache` 的自由链表取槽位；若为空则向 `mcentral` 申请一个 `span` 补充。
- 大对象（> 32KB）：直接向 `mheap` 申请新的 `span`，必要时从操作系统映射页。
- 零填策略：若 `needzero` 为真，保证返回的内存已清零（可复用“已零”的块或执行清零）。

## 虚拟内存与地址空间

- 运行时在进程地址空间中预留 `arena`（总容量上限很大，典型实现达到数百 GB），按需映射至物理内存。
- 操作系统层通过 `mmap`/`VirtualAlloc` 等接口供给页；仅访问时才产生物理内存消耗。
- `spans`：页到 `mspan` 的查找表；`bitmap`：每对象两位的标记位图，供 GC 并发标记与清扫。
- 通过地址与 `arena_start` 的偏移快速定位所属 `span` 与标记位。

## 与 GC 的协作

- Go 的并发标记清扫 GC 与分配器紧密协同：分配时写屏障保障可达性，清扫阶段将可复用对象槽位回收到各层级自由链表。
- 触发节奏由自适应“pacer”和 `GOGC` 控制，一般在堆较上次标记增长到一定比例时启动新一轮 GC。
- 清扫完成后，空闲块通过 `mcentral`/`mcache` 再次参与分配，减少外部碎片与锁争用。

## 性能设计与权衡

- 局部化：小对象命中 `mcache`，绝大多数分配不涉及全局锁。
- 批量化：`mcache` 向 `mcentral` 批量索取 `span`，降低锁竞争与系统调用频率。
- 尺寸离散化：有限 size class 控制内部浪费（尾部未用）与外部碎片。
- 清零优化：优先复用已清零页/块，减少额外清零成本。

## 常见问题与实践

- 逃逸分析决定栈/堆分配；减少返回指针、闭包捕获与接口装箱可降低堆压力与 GC 负担。
- 高频小对象会增加 GC 压力；复用 `[]byte` 缓冲区、使用对象池（谨慎）可减少分配。
- 大对象直接走 `mheap`，更可能与 OS 交互；避免突发超大 `slice`/`map`，注意分配峰值。
- size class 带来的“尾部浪费”是性能换取的折中；总体可通过合理尺寸选择与复用来控制。

## 关键入口与源码

- `runtime/malloc.go`：`mallocgc` 与 `mcache`/`mcentral`/`mheap` 协作入口。
- `runtime/mheap.go`：堆与 `span` 管理。
- `runtime/sizeclasses.go`：尺寸分类表与生成程序。
- `runtime/mbitmap.go`：GC 标记位图与相关操作。
- `runtime/stack.go`：栈与逃逸相关工具。

## 术语速查

- `Mutator`：用户程序，读写对象的代码。
- `Allocator`：内存分配器。
- `Collector`：垃圾收集器。
- `Span`：由若干页组成的连续内存块。
- `Size Class`：对象尺寸类别。
- `Arena`：堆对象的预留虚拟地址空间。
- `Tiny 分配`：无指针超小对象的打包分配路径。
- `Central`：按尺寸的中央自由链表。
- `P/mcache`：每个逻辑处理器的线程缓存。

